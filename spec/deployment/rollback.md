# docs/deployment/rollback.md

**バッジ:** `🚫 実装コード非出力` `🚫 C/C++依存禁止`

> HoneyLink™ のロールバックおよび回復戦略を定義します。自動・手動の手順、意思決定基準、コミュニケーションを整理し、実装コードや C/C++ 依存は含めません。

## 目次
- [目的と範囲](#目的と範囲)
- [ロールバック分類](#ロールバック分類)
- [トリガーと判定基準](#トリガーと判定基準)
- [自動ロールバック手順](#自動ロールバック手順)
- [手動ロールバック手順](#手動ロールバック手順)
- [データ整合性チェックリスト](#データ整合性チェックリスト)
- [コミュニケーションフロー](#コミュニケーションフロー)
- [事後分析と改善](#事後分析と改善)
- [受け入れ基準 (DoD)](#受け入れ基準-dod)

## 目的と範囲
- 本番・ステージング環境のリリース失敗時に迅速かつ安全に復旧する。
- ソフトウェアデプロイ、インフラ変更、暗号鍵更新を対象とする。
- 手順は [docs/deployment/ci-cd.md](ci-cd.md) と同期し、C/C++ 製ツールには依存しない。

## ロールバック分類
| 種別 | 対象 | 方法 | 最大所要時間 |
|------|------|------|---------------|
| アプリケーション | コンテナ/マイクロサービス | GitOps 自動ロールバック | 10 分 |
| インフラ | IaC 適用ミス | Terraform/Bicep `plan` 差戻し | 30 分 |
| データ | スキーマ/データ不整合 | 事前スナップショットから復旧 | 60 分 |
| セキュリティ | 鍵/証明書更新失敗 | 旧鍵へ切替 + 強制再配布 | 15 分 |

## トリガーと判定基準
- 自動トリガー: SLO 違反, エラー率 > 2%, Latency P99 > 150ms, Critical アラート。
- 手動トリガー: SRE/Incident Commander の判断。
- 判定ロジックは Observability スタック (Rust 実装) で評価、C/C++ 製エージェントは禁止。

## 自動ロールバック手順
1. パイプラインが異常検知 → カナリア/段階展開を即停止。
2. GitOps コントローラが直近安定版マニフェストへリバート。
3. 健全性チェック (ヘルスプローブ, KPI) が合格するまで待機。
4. 結果を Slack/PagerDuty へ通知、[docs/testing/metrics.md](../testing/metrics.md) に自動記録。

## 手動ロールバック手順
1. Incident Commander がロールバックを宣言、Slack `#incident` で告知。
2. IaC 変更は `terraform/bicep rollback` プロセスで直近安定版を再適用。
3. データロールバック: 事前スナップショットからリストア → 整合性チェックリスト実行。
4. 確認後、ステークホルダーへ復旧完了を報告。

## データ整合性チェックリスト
- DB: スキーマバージョン, マイグレーションテーブル。
- 時系列データ: 欠損/重複チェック (Rust ツール)。
- キュー/ストリーム: 未処理イベント数 0。
- ケイデンス: 15 分以内に完了。

## コミュニケーションフロー
- 役割: Incident Commander, SRE Oncall, プロダクト代表, コミュニケーションリード。
- チャンネル: Slack Incident, PagerDuty, Status Page, 顧客メール。
- 外部コミュニケーションはコンプライアンスチーム承認後に発信。

## 事後分析と改善
- 72 時間以内に RCA を作成し、[docs/notes/decision-log.md](../notes/decision-log.md) に登録。
- 改善項目は [docs/roadmap.md](../roadmap.md) の Tech Debt バックログへ追加。
- テスト補強: 該当箇所の単体/統合/E2E/性能テストを見直し。

## 受け入れ基準 (DoD)
- ロールバック分類・手順・トリガーが明文化されている。
- データ整合性チェックとコミュニケーションが定義されている。
- C/C++ 依存排除が明示されている。
- 他ドキュメントとのリンクが整合している。
- RCA と改善サイクルが明文化されている。