# docs/performance/benchmark.md

**バッジ:** `🚫 実装コード非出力` `🚫 C/C++依存禁止`

> HoneyLink™ の性能検証とベンチマーク計画を定義します。シナリオ・指標・ツール構成を示し、実装コードや C/C++ 依存は含めません。

## 目次
- [テスト目的と対象範囲](#テスト目的と対象範囲)
- [ワークロードシナリオ](#ワークロードシナリオ)
- [テスト環境構成](#テスト環境構成)
- [ベンチマーク手順](#ベンチマーク手順)
- [計測指標と合格基準](#計測指標と合格基準)
- [モニタリングとデータ収集](#モニタリングとデータ収集)
- [レポーティングとフィードバックループ](#レポーティングとフィードバックループ)
- [スケジュールと責任分担](#スケジュールと責任分担)
- [受け入れ基準 (DoD)](#受け入れ基準-dod)

## テスト目的と対象範囲
- 主要指標: レイテンシ (P50/P95/P99), スループット, パケット損失率, リカバリ時間。
- 対象: コントロールプレーン API, データプレーンメッセージ処理, OTA 配信パイプライン。
- ギャップ分析: [docs/performance/scalability.md](scalability.md) の SLO を満たすこと。
- プロトコル実装は Rust / WASM を利用し、C/C++ ベースのロードジェネレータは禁止。

## ワークロードシナリオ
| シナリオ | 内容 | ボリューム | 目的 |
|----------|------|------------|------|
| Baseline Telemetry | 正常系センサーデータ 18k TPS | 30 分 | レイテンシ基準測定 |
| Burst Telemetry | 45k TPS バーストを 10 分継続 | 3 ラウンド | バックプレッシャ動作確認 |
| Command Storm | 下りコマンド 12k TPS, 優先度混在 | 20 分 | QoS レベル維持確認 |
| Pairing Surge | 新規ペアリング 6k TPS | 15 分 | ハンドシェイク耐性 |
| OTA Wave | 2k TPS の差分 OTA | 60 分 | 帯域確保とリトライ制御 |

## テスト環境構成
- リージョン: 本番同等構成 (3 AZ) をステージングで再現。
- インフラ: IaC テンプレートを [docs/deployment/infrastructure.md](../deployment/infrastructure.md) と同期。
- テストクライアント: Rust 製ロードジェネレータ (Tokio ベース)、WebAssembly エッジエージェント。
- データ: 合成データ + PII 排除済みサンプル。生成ルールは [docs/testing/metrics.md](../testing/metrics.md) 参照。

## ベンチマーク手順
1. テストプラン承認 (QA + SRE + プロダクト)。
2. 環境プロビジョニングと構成ドリフトチェック。
3. 30 分ウォームアップ → シナリオ実行 → 15 分クールダウン。
4. 各シナリオ終了後に KPI を即時計算し SLA 達成可否を判定。
5. 守備範囲: 直近の[docs/security/vulnerability.md](../security/vulnerability.md) に記載された脅威対策が有効であることを確認。

## 計測指標と合格基準
| 指標 | 合格ライン | 備考 |
|------|------------|------|
| 平均レイテンシ | ≤ 45ms | Baseline Telemetry |
| P99 レイテンシ | ≤ 120ms | 全シナリオ共通 |
| スループット | ≥ 95% の期待値 | バースト時も維持 |
| パケット損失 | ≤ 0.2% | Retransmission 含む |
| リカバリ時間 | ≤ 5 分 | 部分障害後の復旧 |

- 追加メトリクス: CPU 60%, メモリ 70%, gRPC エラー率 0.5% 未満。
- 不合格時は RCA を 3 営業日以内に提出し、差戻しを [docs/notes/decision-log.md](../notes/decision-log.md) へ登録。

## モニタリングとデータ収集
- OpenTelemetry → OTLP Exporter → 時系列 DB。
- トレースサンプリング 20%。特定シナリオ中は 100% へ昇格。
- メトリクスは Rust ベースの Collector に集約、C/C++ ネイティブエージェントは排除。
- ログ整形: JSON Lines + Honeycomb 互換スキーマ。

## レポーティングとフィードバックループ
- レポート形式: KPI サマリ, レイテンシヒートマップ, ボトルネック分析, 改善提案。
- 成果物は Confluence と [docs/testing/metrics.md](../testing/metrics.md) にアップロード。
- 改善提案はロードマップのエンジニアリングバックログへ連携。
- 結果が SLO 達成なら [docs/deployment/ci-cd.md](../deployment/ci-cd.md) のゲートを解放。

## スケジュールと責任分担
| フェーズ | 頻度 | 担当 |
|----------|------|------|
| 計画策定 | 四半期 | QA リード + SRE |
| 実行 | 四半期 | パフォーマンスチーム |
| 結果レビュー | 四半期 | プロダクト + SRE |
| 改善施策実装 | 継続 | 各領域オーナー |

## 受け入れ基準 (DoD)
- すべてのワークロードについて目的・ボリューム・成功基準が記述されている。
- テスト環境と手順が他ドキュメントと整合している。
- モニタリングおよびレポートプロセスが SLO と連動している。
- C/C++ 依存が排除され、関連ドキュメントへの参照が含まれている。
- 責任分担とスケジュールが明確。