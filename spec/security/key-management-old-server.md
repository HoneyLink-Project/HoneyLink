# HoneyLink™ 鍵管理仕様書

## 目的
HoneyLink™ における鍵管理の全体像を明文化し、オンプレミスやエアギャップ環境を含むあらゆる導入形態で一貫したセキュリティ水準を確保する。本仕様は実装言語に依存せず、暗号モジュールとして C/C++ ベースのライブラリを利用しないことを前提とする。

## 鍵階層
| 層 | 用途 | 生成元 | 保存先 |
|----|------|--------|---------|
| ルート信頼アンカー (RTA) | 全体の信頼チェーンを署名 | FIPS 140-3 対応 HSM または専用セキュアエレメント | オフライン制御ゾーン内セキュア保管庫 + HSM トークン |
| 中間 CA / サービス鍵 | コントロールプレーン、サービス間認証 | オフライン署名ステーション (Rust + HSM ワークフロー) | 分離ネットワーク上の HSM / Vault クラスタ |
| エッジ / デバイス鍵 | デバイス識別、セッション派生 | デバイス内 TRNG + X25519 | デバイス内セキュアエレメント |
| セッション鍵 | ストリーム暗号化 (ChaCha20-Poly1305) | X25519 → HKDF-SHA512 | 揮発メモリのみ |

## ライフサイクル
| フェーズ | RTA | 中間 CA | デバイス鍵 | セッション鍵 |
|----------|-----|---------|-------------|-------------|
| 生成 | 手動 (2人承認) | 自動バッチ (mTLS) | デバイス初期化時 | ハンドシェイク毎 |
| 配布 | 物理メディア (オフライン) | オンプレ Vault + mTLS | ペアリング API (mTLS + 登録コード) | HLST チャネル内 |
| ローテーション | 5 年 / インシデント時 | 12 ヵ月 / 検証失敗時 | 90 日 / 失効イベント | 接続ごと + 24 時間以内再生成 |
| 失効 | Secure Erase + 監査ログ閉鎖 | CRL / OCSP | CRL + 自己破棄 | ハンドシェイク終了時 |
| 監査 | 手動台帳 + SBOM | GitOps トレース | デバイス台帳 | セッションログ (匿名化) |

## 生成フロー詳細
1. **ルート鍵生成**
   - オフライン HSM 内で `ECDSA P-384` を生成。
   - 生成ログは印刷物 + デジタル (Write-Once Media) で保全。
   - オフラインでのみ利用し、使用時は短時間で再隔離。
2. **中間 CA 登録**
   - 署名リクエスト (CSR) は署名専用ネットワーク経由で RTA に搬送。
   - 成功後に GitOps リポジトリへコミットし、監査証跡を自動付与。
3. **デバイス鍵発行**
   - デバイスは製造ラインで TRNG → X25519 ペアを生成。
   - パブリック鍵を含む登録パッケージを QR/USB で搬送し、コントロールプレーンに登録。
4. **セッション鍵派生**
   - ハンドシェイク時に X25519 → HKDF-SHA512 でセッション鍵を導出。
   - 揮発メモリにのみ配置し、シャットダウン時に即座にゼロ化。

## 配布/登録チャンネル
- **物理オフライン配送:** ルート/中間素材は耐タンパメディアで配送。受領時に 4 眼原則で確認。
- **P2Pペアリング:** QRコード/PIN + ECDH鍵交換。詳細は `spec/security/auth.md` (TOFU信頼モデル) を参照。
- **ディレクトリ同期:** オンプレ Vault クラスタ間は Gossip + mTLS で同期。クラウド環境も利用可能だが必須ではない。

## ローテーションポリシー
- **スケジュール:**
   - RTA: 5 年ごとに新規生成。旧鍵は HSM 内で暗号消去 (Secure Erase/NIST SP 800-88 準拠) を実施し、監査ログで廃止を確定。
   - 中間 CA: 12 ヵ月ごとに再発行。旧証明書は CRL に登録し失効通知を配信。
   - デバイス鍵: 90 日 + 異常検知時に即時ローテーション。
- **イベントトリガ:**
   - 不正アクセス兆候、監査ログ改ざん、構成ドリフトが検出された場合、30 分以内に緊急ローテーションワークフローを起動。
   - エアギャップ環境では、署名オペレーションを手動承認 (ワンタイムハードウェアトークン) で実施。

## 失効 & 破棄
- CRL と OCSP を併用し、ペアリング API による失効通知をリアルタイム伝播。
- デバイス失効時は、セキュアエレメントの鍵消去 API を呼び出し、再登録には製造ラインの再検証を要求。
- ルート鍵破棄は HSM 内の Secure Erase 手順を実施し、監査証跡 (ログ + 承認署名) を保全する。

## 保護要件
- 鍵素材は常に FIPS または ISO/IEC 19790 準拠のモジュールで保管。
- デバイス側は Rust/WASM 実装の暗号層のみを利用。C/C++ ベースのライブラリは禁止。
- 揮発メモリにはガベージコレクション前にゼロ化ルーチンを実行し、メモリダンプ防止のためページングを禁止。

## 監査・可観測性
- すべての操作は OpenTelemetry Span で追跡し、暗号素材はマスキングした状態で SIEM へ送信。
- 監査イベント: 生成、署名、配布、失効、復旧試行。
- メトリクス: 成功/失敗率、ローテーション所要時間、承認経路、手動介入回数。

## インシデント対応マトリクス
| シナリオ | 対応手順 | SLA |
|----------|-----------|-----|
| 鍵漏洩疑い | 緊急ローテーション + 監査ログ完全取得 + 影響範囲報告 | 30 分検知、4 時間以内封じ込め |
| HSM 障害 | フェイルオーバー HSM へ切替、SBOM で整合性検証 | 15 分以内切替 |
| CRL 配信失敗 | 再配信 → フォールバック手動配布 → 事後レビュー | 60 分以内復旧 |
| エアギャップ拠点ローテーション | 物理メディア交換 + 署名承認ダブルチェック | 24 時間以内完了 |

## 関連資料
- `docs/security/encryption.md`: 通信・保存時暗号化の詳細
- `docs/requirements.md`: FR-02, NFR-03, NFR-08 に準拠
- `docs/testing/security.md`: 鍵管理テストケース
- `docs/deployment/runbook.md`: ロールバック/ローテーション運用
