# docs/security/encryption.md

**バッジ:** `🚫 実装コード非出力` `🚫 C/C++依存禁止`

> HoneyLink™ における暗号化と鍵管理の仕様を定義します。純粋な仕様記述に留め、実装コードや C/C++ 依存モジュールを含みません。

## 目次
- [docs/security/encryption.md](#docssecurityencryptionmd)
  - [目次](#目次)
  - [暗号ポリシー概要](#暗号ポリシー概要)
  - [転送中の暗号化](#転送中の暗号化)
  - [保存時の暗号化](#保存時の暗号化)
  - [鍵管理とローテーション](#鍵管理とローテーション)
  - [鍵スコープと権限分離](#鍵スコープと権限分離)
  - [秘密情報管理](#秘密情報管理)
  - [SBOMとコンプライアンス](#sbomとコンプライアンス)
  - [監査とモニタリング](#監査とモニタリング)
  - [受け入れ基準 (DoD)](#受け入れ基準-dod)

## 暗号ポリシー概要
- **標準:** NIST SP 800-56A, RFC 7748, RFC 8439 に準拠。
- **アルゴリズム:** 鍵合意 X25519、鍵導出 HKDF-SHA512、対称暗号 ChaCha20-Poly1305。
- **ハッシュ:** SHA-512。C/C++ で実装された暗号ライブラリは禁止。

## 転送中の暗号化
| チャネル | プロトコル | 仕様 |
|----------|------------|------|
| セッション制御 | HoneyLink Secure Transport (HLST) | mTLS + ChaCha20-Poly1305 |
| テレメトリ | OTLP/gRPC over TLS 1.3 | AKE: TLS 1.3 (PSK禁止) |
| デバイス間 | DTLS 1.3 Equivalent | Fallback として WireGuard 互換設定 |

- すべてのチャネルで Perfect Forward Secrecy を確保。
- 証明書は オンプレ HSM または信頼済みマネージド PKI で発行。失敗時は即時失効。

## 保存時の暗号化
| データ種別 | ストレージ | 暗号方式 |
|------------|------------|-----------|
| セッション秘密 | HSM / セキュアエレメント | AES-256-GCM (ハードウェア内) |
| ログ/監査 | 書き換え不可メディア (WORM/オフライン媒体) | サーバサイド暗号化 + 専用顧客鍵 |
| プロファイル設定 | 分散SQL or エッジキー値ストア | カラムレベル暗号 + アプリ層で再暗号化 |

- バックアップは暗号化済みで地理的に分離した保管庫 (オフライン可) に保存。復号鍵アクセスは 4 眼原則。

## 鍵管理とローテーション
- **鍵管理層:** オンプレ HSM、セキュアエレメント、またはクラウド非依存のマネージド KMS。C/C++ ベースの暗号モジュールは禁止。
- **ローテーション:** 90 日ごとに自動。セッション鍵は毎接続生成。
- **キー階層:** ルート (HSM) → サービスマスター → セッション/データキー。
- **緊急ローテーション:** インシデント発生時 30 分以内に鍵再発行。エアギャップ環境では手動承認フローを加える。

## 鍵スコープと権限分離
| キー種別 | 用途 | アクセス主体 |
|----------|------|--------------|
| `k_root` | KMS内部、メタ操作のみ | セキュリティ担当 (HSM) |
| `k_service` | セッション管理サービス | Session Orchestrator |
| `k_profile` | プロファイルデータ暗号 | Policy Engine |
| `k_telemetry` | 観測データ | Telemetry & Insights |

- 各キーは最小権限アクセス。ABAC 条件 (region, time, role) を併用。

## 秘密情報管理 (P2Pローカル設計)
- シークレットは OS Keychain (Windows DPAPI/macOS Keychain/Linux Secret Service) + ローカルファイル (`~/.honeylink/keys/*.pem`, 0600 permissions) に保管。
- 取得はOS API経由 (no network access)。ネットワーク分離環境でも動作。
- YAML/JSON で「暗号化済み」フラグを付与し、未暗号化を禁止。

## SBOMとコンプライアンス
- 暗号モジュールの由来を SBOM で管理。ライセンスと監査履歴を保持。
- 各リリースで FIPS 140-3 準拠の有無を確認し、必要なら FIPS対応モードを使用。

## 監査とモニタリング
- KMS API 呼び出しを[docs/security/vulnerability.md](./vulnerability.md)の監査に連携。
- メトリクス: 鍵ローテーション成功率 100%、失敗通知 SLA 5 分。
- アラート閾値: ローテーション遅延 > 1 時間、アクセス違反検知即時通知。

## 受け入れ基準 (DoD)
- 転送/保存の暗号方式が明記され、PFS・ローテーション方針が定量化されている。
- 鍵スコープと権限分離表が存在し、RBAC/ABAC ポリシーに接続されている。
- 秘密管理・監査戦略が他ドキュメント (vulnerability, deployment) と整合している。
- C/C++依存を排した前提が明文化されている。
- SBOM とコンプライアンス要求がロードマップに反映可能な形で記述されている。
