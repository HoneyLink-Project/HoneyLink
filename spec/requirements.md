# docs/requirements.md

**バッジ:** `🚫 実装コード非出力` `✅ P2P設計` `✅ サーバーレス` `🚫 C/C++依存禁止`

> HoneyLinkは**Bluetoothの完全上位互換**を目指すPure P2Pプロトコルです。中央サーバー、データベース、アカウント登録は一切不要で、デバイス間が直接通信します。

## 目次
- [P2P設計原則](#p2p設計原則)
- [ペルソナ](#ペルソナ)
- [ユースケース](#ユースケース)
- [P2P機能要件](#p2p機能要件)
- [P2P非機能要件](#p2p非機能要件)
- [Bluetoothとの比較](#bluetoothとの比較)
- [環境要件](#環境要件)
- [制約と禁止事項](#制約と禁止事項)
- [成功指標](#成功指標)
- [受け入れ基準 (DoD)](#受け入れ基準-dod)

## P2P設計原則

### 完全サーバーレス
- ❌ 中央サーバー不要
- ❌ データベース不要
- ❌ アカウント登録・ログイン不要
- ❌ クラウドAPI不要
- ✅ デバイス間直接通信のみ

### Bluetooth互換UX
- **デバイス発見:** Bluetooth設定画面と同じ「近くのデバイス」リスト
- **ペアリング:** QRコード/PINコード/NFC (Bluetoothと同じ手順)
- **接続:** タップするだけで自動接続 (2回目以降)
- **切断:** 設定画面から「切断」「忘れる」

### ローカルファースト
- **鍵保存:** `~/.honeylink/keys/` (ローカルのみ)
- **信頼済みピア:** `~/.honeylink/trusted_peers.json`
- **メトリクス:** `~/.honeylink/metrics/metrics.db` (サーバー送信なし)
- **ポリシー:** `~/.honeylink/policies.json` (ローカル判断)

## ペルソナ

| 名称 | 役割 | ゴール | HoneyLinkでの解決 |
|------|------|--------|-------------------|
| **Alex** (ゲーマー) | コントローラー + ヘッドセット同時接続 | Bluetooth以下のレイテンシ | P99 ≤ 6ms (Bluetooth 30-50ms) |
| **Yuki** (AR/VR開発者) | 複数デバイス空間同期 | 10台同時接続、ズレ < 5cm | 100並列ストリーム (Bluetooth: 3-5個) |
| **Maria** (IoTエンジニア) | センサー群管理 | 簡単ペアリング、サーバーレス | QRコード一括ペアリング、ローカル管理 |
| **Kenji** (プライバシー重視ユーザー) | データ漏洩リスク回避 | クラウド不使用 | 全データローカル、サーバー通信ゼロ |
| **Zoe** (企業IT管理者) | オフライン環境での展開 | インターネット不要 | mDNS/BLEローカル発見のみ |

## ユースケース

### 1. ゲーミング入力 + 音声同時配信 (Bluetooth超越)
- **トリガ:** ユーザーがコントローラーとヘッドセットをPCに接続
- **手順:**
  1. PC画面に「近くのデバイス」表示 (mDNS/BLE自動発見)
  2. コントローラータップ → QRコード表示
  3. ヘッドセットでQRスキャン → ペアリング完了 (10秒以内)
  4. P2P QUIC接続確立 → 2ストリーム同時開始
- **成功条件:**
  - 入力レイテンシ: P95 ≤ 6ms (Bluetooth: 30ms)
  - 音声同期ズレ: < 20ms
  - 接続範囲: 100m (Bluetooth: 10m)
- **参照:** [docs/performance/benchmark.md](./performance/benchmark.md)

### 2. IoTセンサー群管理 (サーバーレス)
- **トリガ:** 工場内100台のセンサーを一括ペアリング
- **手順:**
  1. 管理デバイスで「QRコード一括表示」モード起動
  2. センサー1台ずつQRスキャン (または全台BLE自動検出)
  3. 各センサーがローカルで鍵交換 (ECDH) → 信頼済みリストに追加
  4. データ収集開始 (P2P直接通信、サーバー経由なし)
- **成功条件:**
  - ペアリング成功率: 99.9%
  - 1台あたり消費電力: ≤ 5mA (Bluetoothと同等)
  - サーバーコスト: $0 (完全ローカル)
- **参照:** [docs/architecture/dataflow.md](./architecture/dataflow.md)

### 3. 8Kメディア転送 (Wi-Fi活用)
- **トリガ:** スマホからTVへ8K映像ストリーミング
- **手順:**
  1. TV側でQRコード表示
  2. スマホでスキャン → P2P WebRTC接続確立
  3. Wi-Fi 6E帯域活用 (最大1Gbps) で8Kストリーム送信
- **成功条件:**
  - 平均スループット: 1.5Gbps (Bluetooth: 2Mbps)
  - フレームドロップ率: < 0.1%
  - NAT越え成功率: 95% (WebRTC STUN)
- **参照:** [docs/modules/transport-abstraction.md](./modules/transport-abstraction.md)

### 4. AR/VRマルチユーザセッション (メッシュP2P)
- **トリガ:** 同一空間で10名が同期体験
- **手順:**
  1. ホストデバイスがmDNSでセッションアナウンス
  2. 参加者が「参加可能セッション」リストから選択
  3. 全デバイスがP2Pメッシュ接続確立 (各デバイス間でECDH)
  4. 空間座標を100Hzで同期
- **成功条件:**
  - 空間同期誤差: < 5cm
  - P99レイテンシ: ≤ 12ms
  - 同時接続数: 10台 (Bluetooth: 7台制限)
- **参照:** [docs/ui/animations.md](./ui/animations.md)

### 5. プライバシー重視ファイル共有
- **トリガ:** 機密ファイルを同僚に送信 (クラウドNG)
- **手順:**
  1. 送信者がファイル選択 → QRコード生成
  2. 受信者がQRスキャン → P2P QUIC接続
  3. ChaCha20-Poly1305暗号化で直接転送
  4. 転送完了後、両端で鍵削除
- **成功条件:**
  - 転送速度: 最大1Gbps (LAN内)
  - サーバー経由: 0バイト (完全P2P)
  - メタデータ漏洩: なし (DNSクエリなし)
- **参照:** [docs/security/encryption.md](./security/encryption.md)

## P2P機能要件

| ID | 分類 | 概要 | Bluetooth比較 | 参照 |
|----|------|------|---------------|------|
| **FR-P2P-01** | デバイス発見 | mDNS/BLE自動検出、5秒以内にリスト表示 | Bluetooth: 同等 | [physical-adapter.md](./modules/physical-adapter.md) |
| **FR-P2P-02** | ペアリング (QR) | QRコード表示/スキャンでECDH鍵交換 (30秒以内) | Bluetooth: 同UX | [crypto-trust-anchor.md](./modules/crypto-trust-anchor.md) |
| **FR-P2P-03** | ペアリング (PIN) | 6桁PIN表示/入力でペアリング | Bluetooth: 同UX | 同上 |
| **FR-P2P-04** | 信頼管理 | TOFU (Trust On First Use)、2回目以降自動接続 | Bluetooth: 同じ | `~/.honeylink/trusted_peers.json` |
| **FR-P2P-05** | P2P接続 | QUIC/WebRTC直接通信、NAT越え (STUN) | Bluetooth: NAT越え不可 | [transport-abstraction.md](./modules/transport-abstraction.md) |
| **FR-P2P-06** | マルチストリーム | 最大100並列ストリーム (Bluetooth: 3-5個) | Bluetooth: 20倍向上 | [qos-scheduler.md](./modules/qos-scheduler.md) |
| **FR-P2P-07** | ローカル鍵保存 | `~/.honeylink/keys/` に暗号化保存 (サーバー送信なし) | Bluetooth: 同等 | OS Keyring統合 |
| **FR-P2P-08** | ローカルメトリクス | SQLiteに保存、サーバー送信なし (GDPR準拠) | Bluetooth: 同等 | [telemetry-insights.md](./modules/telemetry-insights.md) |
| **FR-P2P-09** | オフライン動作 | インターネット不要 (mDNS/BLEのみ) | Bluetooth: 同等 | - |
| **FR-P2P-10** | デバイス忘れる | 信頼済みリストから削除 → 再ペアリング要求 | Bluetooth: 同UX | - |

## P2P非機能要件

### 性能 (Bluetooth超越)

| 指標 | 要件 | Bluetooth比較 | 理由 |
|------|------|---------------|------|
| **レイテンシ (LL)** | P95 ≤ 6ms | 5倍高速 (BT: 30ms) | QUIC + Wi-Fi Direct |
| **レイテンシ (音声)** | P95 ≤ 15ms | 2倍高速 (BT: 30-50ms) | QoS優先制御 |
| **帯域幅** | 最大1Gbps | 500倍向上 (BT: 2Mbps) | Wi-Fi 6E活用 |
| **通信範囲** | 最大300m (屋外) | 3倍拡大 (BT: 100m) | Wi-Fi Long Range |
| **並列ストリーム** | 100個 | 20倍向上 (BT: 3-5個) | QUIC多重化 |
| **ペアリング時間** | ≤ 30秒 | 同等 (BT: 30秒) | QR/PIN UX |
| **デバイス発見** | ≤ 5秒 | 同等 (BT: 数秒) | mDNS/BLE |
| **NAT越え成功率** | ≥ 95% | BT不可 | WebRTC STUN/TURN |

### 可用性・信頼性

- **接続成功率:** 99.5% (mDNS/BLE両方失敗時のみNG)
- **パケット損失耐性:** FECで5%まで再構築可能 (Bluetooth: 1-2%)
- **自動再接続:** 接続断後10秒以内に自動復旧
- **電力効率:** アイドル時 < 10mA (Bluetoothと同等)

### セキュリティ・プライバシー (Bluetooth超越)

| 項目 | 要件 | Bluetooth比較 |
|------|------|---------------|
| **鍵交換** | X25519 ECDH (256bit) | BT: P-256 (同等) |
| **暗号化** | ChaCha20-Poly1305 AEAD | BT: AES-128-CCM (HoneyLink強化) |
| **鍵派生** | HKDF-SHA512 | BT: HMAC-SHA256 (HoneyLink強化) |
| **中間者攻撃対策** | TOFU + 鍵変更警告 | BT: 同等 |
| **プライバシー** | 全データローカル、サーバー送信ゼロ | BT: 同等 |
| **メタデータ保護** | デバイス名/ID暗号化 (BLEアドバタイズ) | BT: 平文 (HoneyLink改善) |

### 運用・可観測性 (サーバーレス)

- **ローカルメトリクス:** SQLiteに保存 (`~/.honeylink/metrics/`)
- **OpenTelemetry互換:** ローカルOTLP Collectorへエクスポート (任意)
- **サーバー送信禁止:** ユーザー明示許可なしでメトリクス外部送信禁止 (GDPR準拠)
- **ログレベル:** ERROR/WARN/INFO/DEBUG (環境変数で切替)
- **デバッグUI:** 任意でGrafana連携 (開発時のみ)

### 拡張性・保守性

- **プロトコルバージョニング:** セマンティックバージョニング (X.Y.Z)
- **後方互換性:** メジャーバージョン内で保証 (例: 1.x.x同士は互換)
- **プロファイル拡張:** JSONベースのプラグイン式 (Gaming, AR/VR, IoT等)
- **Pure Rust実装:** C/C++依存ゼロでクロスプラットフォーム

### アクセシビリティ・国際化

- **WCAG 2.2 AA準拠:** ペアリングUI、デバイスリスト
- **スクリーンリーダー対応:** デバイス発見音声通知
- **多言語対応:** en, ja, es, zh (RTLレイアウト対応)
- **カラーブラインド対応:** 接続状態を色+アイコンで表示

## Bluetoothとの比較

| 機能 | Bluetooth 5.3 | HoneyLink P2P | 勝者 |
|------|---------------|---------------|------|
| **ペアリングUX** | QR/PIN | QR/PIN/NFC | 引き分け ✅ |
| **通信範囲** | ~100m (屋内10m) | 最大300m | **HoneyLink** 🏆 |
| **レイテンシ** | 30-50ms | ≤12ms (P99) | **HoneyLink** 🏆 |
| **帯域幅** | ~2Mbps | 最大1Gbps | **HoneyLink** 🏆 |
| **並列ストリーム** | 3-5個 | 100個 | **HoneyLink** 🏆 |
| **暗号化** | AES-128-CCM | ChaCha20-Poly1305 | **HoneyLink** 🏆 |
| **NAT越え** | 不可 ❌ | WebRTC STUN ✅ | **HoneyLink** 🏆 |
| **消費電力** | ~5mA (アイドル) | ~10mA | Bluetooth 🏆 |
| **サーバー** | 不要 ✅ | 不要 ✅ | 引き分け ✅ |
| **規格成熟度** | 20年の実績 | 新規 | Bluetooth 🏆 |

### HoneyLinkが優れる点
1. **超低レイテンシ:** ゲーミング・AR/VR向け (6ms vs 30ms)
2. **高帯域:** 8K映像転送可能 (1Gbps vs 2Mbps)
3. **マルチストリーム:** IoT大規模接続 (100個 vs 5個)
4. **NAT越え:** ファイアウォール越え通信可能
5. **強化暗号:** ChaCha20-Poly1305 (より強固)

### Bluetoothが優れる点
1. **消費電力:** アイドル時半分 (5mA vs 10mA)
2. **規格成熟度:** 20年の実績、全デバイス対応
3. **ハードウェアコスト:** Bluetoothチップ安価

## 環境要件

### クライアントデバイス
- **OS:** Windows 10+, macOS 13+, Linux (Ubuntu 22.04+), iOS 16+, Android 12+
- **無線:** Wi-Fi 5以上 (Wi-Fi 6E推奨), BLE 5.0以上
- **RAM:** 最小256MB (組み込み), 推奨1GB (PC/スマホ)
- **ストレージ:** 最小50MB (アプリ + ローカルデータ)

### ネットワーク
- **ローカルネットワーク:** mDNS許可、UDPマルチキャスト有効
- **ファイアウォール:** QUIC (UDP 50000-50100), WebRTC (UDP 49152-65535) 開放
- **NAT越え:** STUN/TURNサーバー設定可能 (デフォルト: Google STUN)

### 開発環境
- **Rust:** 1.89.0 (rust-toolchain.toml固定)
- **Node.js:** 22.15.0+ (UI開発)
- **Docker:** 任意 (OTLP Collector開発時のみ)

## 制約と禁止事項

### 絶対禁止
- ❌ **中央サーバー依存:** 全機能はローカル完結必須
- ❌ **データベース:** PostgreSQL/MySQL等の外部DB禁止
- ❌ **クラウドAPI:** AWS/Azure/GCP等のクラウドサービス依存禁止
- ❌ **アカウント登録:** ユーザーID/パスワード/OAuth不要
- ❌ **C/C++依存:** ネイティブライブラリ依存禁止 (Pure Rust)
- ❌ **テレメトリー自動送信:** ユーザー明示許可なしでメトリクス外部送信禁止

### 技術制約
- **最大デバイス数:** 1セッション100台まで (メモリ制約)
- **ストリーム数:** 1デバイス100並列まで
- **ファイルサイズ:** P2P転送は10GB/ファイル推奨上限
- **NAT越え:** STUN/TURN設定必須 (デフォルトGoogle STUN使用)

### スコープ外
- インターネット経由リモート接続 (将来: Relay経由検討)
- メッシュルーティング (将来: マルチホップ検討)
- クラウド同期 (ローカルファースト原則)

## 成功指標

### KPI (Key Performance Indicators)

| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| **デバイス発見時間** | 中央値 ≤ 3秒 | mDNS/BLE応答時間 |
| **ペアリング成功率** | ≥ 99% | QR/PIN完了率 |
| **P2P接続成功率** | ≥ 99.5% | QUIC/WebRTC確立率 |
| **レイテンシ (LL)** | P99 ≤ 12ms | ストリームRTT測定 |
| **帯域利用率** | ≥ 80% (Wi-Fi 6E時) | スループット測定 |
| **パケット損失率** | ≤ 1% (通常時) | FEC前損失率 |
| **NAT越え成功率** | ≥ 95% | WebRTC ICE成功率 |
| **電力効率** | アイドル ≤ 10mA | バッテリー消費測定 |

### SLI (Service Level Indicators)

ローカルメトリクス (`~/.honeylink/metrics/`) に記録:
- P2P接続数 (アクティブ/累計)
- ストリームレイテンシ分布 (P50, P90, P99)
- パケット損失率 (送信/受信)
- デバイス発見時間分布
- ペアリング所要時間
- QUIC/WebRTC接続成功/失敗数

### ユーザー満足度 (定性指標)

- **ペアリング体験:** "Bluetoothと同じくらい簡単" (目標: 90%同意)
- **接続範囲:** "Bluetoothより広い" (目標: 80%同意)
- **レイテンシ:** "ゲームで遅延を感じない" (目標: 85%同意)
- **プライバシー:** "サーバー不要で安心" (目標: 95%同意)

## 受け入れ基準 (DoD)

### P2P設計基準
- ✅ 全機能が中央サーバーなしで動作 (mDNS/BLEローカル発見)
- ✅ ペアリングがQR/PINで完結 (アカウント作成不要)
- ✅ 鍵管理がローカルファイルシステム (`~/.honeylink/`) で完結
- ✅ メトリクスがローカルに保存 (サーバー送信なし)
- ✅ NAT越えがWebRTC STUNで実現 (95%成功率)
- ✅ P99レイテンシ ≤ 12ms (Bluetooth比3倍高速)
- ✅ 帯域幅 ≥ 100Mbps (Bluetooth比50倍)
- ✅ 100並列ストリーム対応 (Bluetooth比20倍)

### セキュリティ基準
- ✅ X25519 ECDH鍵交換実装
- ✅ ChaCha20-Poly1305 AEAD暗号化
- ✅ TOFU (Trust On First Use) 信頼モデル
- ✅ 鍵変更検出・警告機能
- ✅ 中間者攻撃対策 (初回ペアリングのみリスク)

### ドキュメント基準
- ✅ 全要件がBluetooth比較を含む
- ✅ ユースケースがP2P手順を明記
- ✅ 非機能要件がローカルファースト原則準拠
- ✅ 制約事項でサーバー依存禁止を明記
- ✅ 成功指標がローカルメトリクス測定方法を含む
- ✅ レビュー記録が[docs/notes/decision-log.md](./notes/decision-log.md)に存在

---

**文書更新履歴**
- 2025-XX-XX: P2P設計に完全書き換え (Control Plane削除、Bluetooth比較追加)
