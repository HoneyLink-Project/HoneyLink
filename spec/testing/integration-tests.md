# docs/testing/integration-tests.md

**バッジ:** `🚫 実装コード非出力` `🚫 C/C++依存禁止`

> HoneyLink™ の統合テスト戦略を定義します。サービス間連携・プロトコル互換性の検証方法を記述し、実装コードや C/C++ 依存は含めません。

## 目次
- [テスト目的と範囲](#テスト目的と範囲)
- [テスト環境と依存サービス](#テスト環境と依存サービス)
- [主要シナリオ](#主要シナリオ)
- [データ管理方針](#データ管理方針)
- [ツールチェーンとオーケストレーション](#ツールチェーンとオーケストレーション)
- [検証ポイントと評価基準](#検証ポイントと評価基準)
- [自動化パイプライン](#自動化パイプライン)
- [リスクとフォールバック](#リスクとフォールバック)
- [受け入れ基準 (DoD)](#受け入れ基準-dod)

## テスト目的と範囲
- 目的: サービス間契約、暗号化チャネル、QoS 制御、デバイスライフサイクルの整合性を確認。
- 範囲: コントロールプレーン API, データプレーン Broker, Edge Gateway, Observability スタック。
- 除外: UI レイヤー (別途 [docs/ui/overview.md](../ui/overview.md)), 細粒度ロジックは [docs/testing/unit-tests.md](unit-tests.md) 参照。

## テスト環境と依存サービス
- ステージング環境をマルチ AZ (3 AZ) で再現し、リージョン内ネットワーク遅延を 10±2ms に調整。
- 依存サービス: マネージドデータベース, メッセージングバス, KMS。全て IaC で構築し、C/C++ 製ミドルウェアは採用しない。
- テスト実行前に[docs/deployment/infrastructure.md](../deployment/infrastructure.md)と構成差分を比較し、ドリフトがないか検証。

## 主要シナリオ
| シナリオ | 目的 | 成功条件 |
|----------|------|----------|
| Secure Pairing Flow | デバイス登録〜鍵配布 | 99.5% 成功率、鍵ローテ通知がブローカーへ届く |
| Telemetry Stream QoS | 優先度ごとの帯域保証 | critical チャネル遅延 < 80ms, bulk 遅延 < 500ms |
| Command Fan-out | 管理ポータル→1万デバイス | 1 分以内に 95% 配信、エラー率 < 0.2% |
| OTA Coordinated Rollout | バッチ配信 + ロールバック | 障害時 5 分以内にロールバック成功 |
| Incident Telemetry Failover | リージョン障害切替 | 2 分以内に DR リージョンへフェイルオーバ、データ欠損 0 |

## データ管理方針
- テストデータは合成生成し、PII/PHI を含めない。
- 事前・事後状態のスナップショットを取得し、差分を自動評価。
- テスト終了後はクリーンアップジョブを実行し、残留トピックや鍵を削除。

## ツールチェーンとオーケストレーション
- オーケストレーション: GitHub Actions + Rust ベースの Orchestrator CLI。
- 依存サービスの挙動再現には WASM サンドボックス化したシュミレータを用いる。C/C++ で書かれたシュミレータは禁止。
- コンテナは distroless ベースを利用し、攻撃面積を最小化。

## 検証ポイントと評価基準
- 契約確認: gRPC/protobuf スキーマ互換性検査。
- セキュリティ: mTLS ハンドシェイクが完了しないケースが存在しないか。
- オブザーバビリティ: OpenTelemetry スパンが 95% 以上整列しているか。
- 状態整合性: イベントソーシングログがユニークかつ順序正しく処理されるか。

## 自動化パイプライン
1. Pull Request → インテグレーションテストジョブをナイトリービルドで実行。
2. 成果はアーティファクト (Junit XML, JSON, HTML ダッシュボード) として保管。
3. 失敗時は自動で [docs/notes/decision-log.md](../notes/decision-log.md) にエントリ草案を生成。
4. 成功後に [docs/deployment/ci-cd.md](../deployment/ci-cd.md) の次ステップ (E2E) へ進む。

## リスクとフォールバック
- 依存サービス障害: 合成モックへ切替、テスト結果は「参考値」でラベル。
- 環境ドリフト: 直ちに IaC を再適用し、再試行は 1 回まで。
- ベースライン未達: RCA を 2 営業日以内に提出し、暫定ブロックを設定。

## 受け入れ基準 (DoD)
- 統合テストの範囲・目的・シナリオが網羅的に記述されている。
- 環境定義と依存関係が他ドキュメントと整合している。
- 自動化パイプラインとフォールバック手順が明文化されている。
- C/C++ 依存を排除することが明示されている。
- 成功基準とメトリクスへの連携が定義されている。