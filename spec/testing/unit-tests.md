# docs/testing/unit-tests.md

**バッジ:** `🚫 実装コード非出力` `🚫 C/C++依存禁止`

> HoneyLink™ の単体テスト方針を定義します。Rust ベースのテストフレームワークやモックガイドラインを記述し、実装コードや C/C++ 依存は含めません。

## 目次
- [テストの目的と範囲](#テストの目的と範囲)
- [テスト設計原則](#テスト設計原則)
- [対象コンポーネントと優先度](#対象コンポーネントと優先度)
- [テスティングツールと依存](#テスティングツールと依存)
- [モック・スタブ方針](#モックスタブ方針)
- [自動化とゲート](#自動化とゲート)
- [品質指標とトラッキング](#品質指標とトラッキング)
- [ワークフロー](#ワークフロー)
- [受け入れ基準 (DoD)](#受け入れ基準-dod)

## テストの目的と範囲
- 目的: コアドメインロジック、暗号ハンドラー、QoS スケジューラ、設定パーサの正確性を検証。
- 範囲外: ネットワーク境界、分散アルゴリズムの整合性 → [docs/testing/integration-tests.md](integration-tests.md) で扱う。
- 成果は [docs/testing/metrics.md](metrics.md) で集計し、SLO 達成度を追跡。

## テスト設計原則
- AAA (Arrange-Act-Assert) 構造を全テストで強制。
- プロパティベーステストを重要モジュールで導入 (例: Key 交換、トピックルーティング)。
- データ駆動 (表形式) テストを活用し、境界値・異常系を網羅。
- 1 テスト = 1 振る舞い。複数アサーションであっても意図は単一に。

## 対象コンポーネントと優先度
| コンポーネント | 優先度 | 目標カバレッジ | 備考 |
|----------------|--------|----------------|------|
| 暗号鍵管理 (Rust) | High | 95% | X25519/HKDF ハンドラー |
| QoS スケジューラ | High | 90% | マルチキュー判定ロジック |
| 設定パーサ | Medium | 85% | TOML/YAML パース |
| Telemetry 正規化 | Medium | 85% | 単位変換・バリデーション |
| ペイロードシリアライザ | Low | 80% | コンパチ確認 |

- カバレッジは命令・分岐両面で測定。例外処理とログパスを含む。

## テスティングツールと依存
- テストランナー: Rust `cargo test` 相当。C/C++ 製テストランナーは禁止。
- プロパティベース: `proptest` または `quickcheck` (Rust 純実装)。
- カバレッジ: `cargo-llvm-cov` などの Rust ツール。生成レポートは HTML + JSON。
- 静的解析: Clippy, cargo-audit をユニットテスト前に実行し diff をブロック。

## モック・スタブ方針
- ポート/アダプタ境界にモックを配置。Trait ベースのモック生成クレート (Rust) を使用。
- ネットワーク呼び出しは完全にスタブ化し、HTTP/QUIC 実ネットワークを使用しない。
- 時刻依存ロジックは `MockClock` で注入し、テスト前後でリセット。
- C/C++ バインディングや FFI モックは禁止。

## 自動化とゲート
- CI パイプライン ([docs/deployment/ci-cd.md](../deployment/ci-cd.md)) で PR ごとにユニットテスト実行。
- 実行結果は GitHub Checks へ連携。失敗時はマージブロック。
- キャッシュを利用した高速化 (sccache)。テスト時間 5 分以内を KPI。

## 品質指標とトラッキング
- カバレッジ閾値: High 優先度モジュールは 90% 以上、その他は 80% 以上。
- フレーク率: 1% 未満。超過時は最優先で安定化タスクを作成。
- 欠陥検出率: リリース前に 70% 以上の欠陥が単体テストで検出されていること。
- 成果指標は [docs/testing/metrics.md](metrics.md) で週次更新。

## ワークフロー
1. テストケース設計 → レビュー (QA + 開発) → 実装。
2. Pull Request にテスト証跡 (Coverage レポート、Clippy 結果) を添付。
3. main ブランチマージ時に全テスト再実行 + 成果をアーカイブ。
4. リグレッション検知は毎晩のスケジュール実行で補完。

## 受け入れ基準 (DoD)
- 単体テストの範囲・優先度・ツールが明確に記載されている。
- モック/スタブ方針と自動化ゲートが定義されている。
- 品質指標がテストメトリクス文書と連動している。
- C/C++ 依存を排除することが明記されている。
- 他の関連文書へのリンクが整合している。