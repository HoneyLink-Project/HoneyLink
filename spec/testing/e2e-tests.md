# docs/testing/e2e-tests.md

**バッジ:** `🚫 実装コード非出力` `🚫 C/C++依存禁止`

> HoneyLink™ のエンドツーエンド (E2E) テスト方針を定義します。ユーザージャーニーと運用シナリオを再現し、実装コードや C/C++ 依存は含めません。

## 目次
- [目的とテスト深度](#目的とテスト深度)
- [主要ユーザージャーニー](#主要ユーザージャーニー)
- [運用シナリオ](#運用シナリオ)
- [テスト環境と構成管理](#テスト環境と構成管理)
- [データおよびシミュレーション](#データおよびシミュレーション)
- [観測と成功判定](#観測と成功判定)
- [自動化フロー](#自動化フロー)
- [リリースゲートとの連携](#リリースゲートとの連携)
- [受け入れ基準 (DoD)](#受け入れ基準-dod)

## 目的とテスト深度
- エンドユーザー視点での機能整合性と運用レジリエンスを検証。
- エッジデバイス、クラウドサービス、管理ポータルを横断する完結ジャーニーを対象。
- 単体・統合テストで検証済みの前提条件を再利用し、E2E では UX と SLA 準拠を重点評価。

## 主要ユーザージャーニー
| ジャーニー | ステップ | 成功基準 |
|------------|----------|----------|
| デバイス導入 | 配布 → ペアリング → 認証 → ダッシュボード確認 | 15 分以内にアクティブ化、アラート無し |
| アラートレスポンス | 異常検知 → 通知 → オペレータ承認 → コマンド送信 | 5 分以内に是正完了、監査ログ整合 |
| OTA リリース | リリース承認 → 段階配信 → ヘルスチェック → 完了報告 | Rollout 中断基準遵守、失敗率 <1% |
| テナント拡張 | 新テナント作成 → ポリシー設定 → ダバイス移行 | 作業時間 30 分以内、ダウンタイム無し |

## 運用シナリオ
- **障害対応:** リージョン障害 → DR 切替 → バックログ解消。
- **セキュリティ:** 鍵漏洩疑い → 強制ローテ → エッジ再認証。 [docs/security/encryption.md](../security/encryption.md) に準拠。
- **パフォーマンス:** ピーク負荷中の SLA 監視。 [docs/performance/scalability.md](../performance/scalability.md) を参照。
- **サポート:** 管理者 UI からのリモート診断とログ取得。

## テスト環境と構成管理
- 本番の 1/4 スケールを維持。Observability/Analytics まで含めた完全複製。
- IaC パラメータは `env=e2e` プロファイルを利用し [docs/deployment/infrastructure.md](../deployment/infrastructure.md) と同期。
- 変更は GitOps 経由で適用。手動設定は禁止。

## データおよびシミュレーション
- デバイスシミュレータは WebAssembly ベースで 1 万台を再現。C/C++ 製シミュレータは禁止。
- テナントデータは匿名化した実データサブセット + 合成データ。
- 正常系・異常系双方でログとテレメトリが収集されるようフィーチャーフラグを設定。

## 観測と成功判定
- 主要 KPI: ジャーニー完了時間、アラート検知率、DR 切替時間、利用者満足度代理指標。
- 可観測性: OpenTelemetry トレース/メトリクス/ログを 100% 収集。
- メトリクスは Honeycomb ダッシュボードに自動公開。基準値を下回る場合はブロッカー。

## 自動化フロー
1. 週次 E2E ジョブ (長時間)。リリース候補前は臨時実行。
2. 手順: 環境フレッシュ → データロード → ジャーニー実行 → 観測レポート生成。
3. 失敗時は自動でロールバックを実行し、チケットを生成。

## リリースゲートとの連携
- E2E 成績は [docs/deployment/ci-cd.md](../deployment/ci-cd.md) のステージングゲートに連携。
- 重大欠陥が残る場合は本番リリースを停止し、RCA を [docs/notes/decision-log.md](../notes/decision-log.md) に登録。
- 成功後は [docs/performance/benchmark.md](../performance/benchmark.md) の性能結果と照合。

## 受け入れ基準 (DoD)
- E2E テストの目的・ジャーニー・運用シナリオが網羅的に定義されている。
- テスト環境とデータ生成方法が記述され、他ドキュメントとリンクしている。
- 成功判定と自動化フローが明文化されている。
- C/C++ 依存排除が明示されている。
- リリースゲートとの関係が整理されている。