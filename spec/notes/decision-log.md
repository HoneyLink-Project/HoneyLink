# docs/notes/decision-log.md

**バッジ:** `🚫 実装コード非出力` `🚫 C/C++依存禁止`

> HoneyLink™ の意思決定記録 (ADR) テンプレートを提供します。技術・運用の重要判断をバージョン管理し、C/C++ 依存や実装コードは含めません。

---

## 利用ガイド
- 意思決定は ID を採番し、コンポーネント・影響範囲を明記。
- ステータスは `提案中 / 承認 / 却下 / 置換` を使用。
- 重大な決定は [docs/roadmap.md](../roadmap.md)、[docs/security/vulnerability.md](../security/vulnerability.md) 等と連携。
- 影響を受ける文書を `Related Docs` に列挙。

## ADR 一覧
| ADR ID | タイトル | 日付 | ステータス | 主要ドメイン | 概要 |
|--------|----------|------|------------|--------------|------|
| ADR-001 | <!-- 例: HoneyLink プロトコル暗号スイート選定 --> | <!-- YYYY-MM-DD --> | 提案中 | セキュリティ | <!-- 一行概要 --> |
| ADR-002 | | | | | |

## ADR テンプレート
```markdown
## ADR-XXX: タイトル
- **日付:** YYYY-MM-DD
- **ステータス:** 提案中 / 承認 / 却下 / 置換
- **オーナー:** 氏名/チーム
- **ドメイン:** アーキテクチャ / セキュリティ / 運用 / 製品
- **関連 KPI/SLO:** <!-- docs/testing/metrics.md など -->
- **Related Docs:** [docs/...](...)

### 背景
- 課題や機会
- 現状の制約

### 決定
- 採用するアプローチ
- 選定理由
- C/C++ 依存を避ける根拠

### 選択肢比較
| 選択肢 | 長所 | 短所 | リスク |
|--------|------|------|--------|
| Option A | | | |
| Option B | | | |

### 影響
- 技術的影響
- 組織的影響
- コスト/スケジュール影響

### 実施計画
1. ステップ1
2. ステップ2
3. 完了条件

### フォローアップ
- 評価タイミング
- メトリクス確認 (例: [docs/testing/metrics.md](../testing/metrics.md))
- 次のアクション
```

## 更新履歴
| 日付 | 変更内容 | 編集者 |
|------|----------|--------|
| YYYY-MM-DD | 初版作成 | 名前 |
| YYYY-MM-DD | ADR-XYZ 追加 | 名前 |

---

## 運用ルール (Operational Procedures)

### 1. 記録フォーマット標準化 (Standardized Record Formats)

#### 1.1 設計変更記録 (Design Change Record)
**形式:** ADR (Architecture Decision Record) 形式を使用  
**必須項目:**
- ADR ID (連番)
- タイトル、日付、ステータス、オーナー
- 背景 (Background): 変更理由、現状の制約
- 決定 (Decision): 採用アプローチ、C/C++ 依存排除の根拠
- 選択肢比較 (Alternatives): 最低2案を比較表で提示
- 影響 (Impact): 技術/組織/コスト/スケジュールへの影響
- 実施計画 (Implementation Plan): 完了条件を含む
- フォローアップ (Follow-up): 評価時期、メトリクス確認リンク

#### 1.2 リスク記録 (Risk Record)
**形式:** ADR 内または独立したリスクエントリ  
**必須項目:**
- リスク ID (例: `RISK-ADR-XXX-001`)
- リスクカテゴリ (技術/セキュリティ/スケジュール/コンプライアンス)
- 発生確率 (低/中/高) × 影響度 (低/中/高)
- 緩和策 (Mitigation Plan): 具体的アクション、責任者、期限
- モニタリング方法: 観測指標、閾値、アラート設定
- 関連 SLO/KPI へのリンク ([spec/testing/metrics.md](../testing/metrics.md))

#### 1.3 RCA (Root Cause Analysis) 記録
**形式:** 独立した RCA セクションまたは関連 ADR への追記  
**必須項目:**
- インシデント ID、発生日時、検出方法
- タイムライン: 発生→検出→初期対応→根本対処の時系列
- 根本原因 (Root Cause): 5 Whys またはフィッシュボーン図の要約
- 是正措置 (Corrective Actions): 短期対応 (24h以内) + 恒久対策 (90日以内)
- 再発防止策 (Preventive Measures): プロセス改善、自動化、監視強化
- 教訓 (Lessons Learned): 他チーム/プロジェクトへの横展開項目
- 検証済み (Verified): 再発がないことを確認した日付とメトリクス

### 2. 72時間記録完了の自動リマインダー (72-Hour Recording Enforcement)

#### 2.1 記録完了タイムライン
- **決定発生から24時間以内:** ドラフト作成 (ステータス: `提案中`)
- **決定発生から48時間以内:** クロスレビュー依頼 (影響を受ける WG へ通知)
- **決定発生から72時間以内:** 最終レビュー完了、ステータス更新 (`承認` / `却下`)

#### 2.2 自動リマインダー設定 (Automated Reminder System)
**実装方法:**
1. **Slackbot 統合:**
   - 新規 ADR 作成時に WG チャネルへ投稿 (例: `#hl-arch-wg`)
   - 24時間後: ドラフト未完了の場合、オーナーへ DM
   - 48時間後: クロスレビュー未完了の場合、関連 WG チェアへ通知
   - 72時間後: 未承認の場合、Governance Council (`#hl-wg-leads`) へエスカレーション
2. **CI/CD フック:**
   - `spec/notes/decision-log.md` の変更を Git pre-commit フックで検出
   - ADR ID の日付フィールドを解析し、72時間経過チェック
   - 期限切れ ADR がある場合、CI で警告を表示
3. **週次サマリー:**
   - 毎週金曜 17:00 JST に `#hl-wg-leads` へ未完了 ADR リストを自動投稿
   - リストには ADR ID、オーナー、経過日数、ステータスを含む

#### 2.3 リマインダー除外条件
- 法務レビュー待ち: ステータスを `法務レビュー中` に設定し、期限を一時停止
- 外部依存待ち: `ブロック中` ステータスを使用し、ブロッカーを明記

### 3. 承認フローとエスカレーションパス (Approval Flow and Escalation Path)

#### 3.1 標準承認フロー
1. **提案作成 (Proposal Creation):**
   - オーナー: ADR ドラフトを作成し、自 WG チャネルへ投稿
   - 期限: 決定発生から24時間以内
2. **クロスレビュー (Cross-Review):**
   - 関連 WG: 影響を受ける WG が技術/セキュリティ/運用観点でレビュー
   - 必須レビュー対象:
     - Architecture WG: 依存関係、後方互換性
     - Security WG: C/C++ 依存排除、暗号/認証への影響
     - Operations WG: 展開可能性、SLO への影響
   - 期限: 24時間 (提案投稿から48時間以内)
3. **承認決定 (Approval Decision):**
   - WG チェア: レビューコメントを統合し、最終判断
   - ステータス更新: `承認` / `却下` / `条件付き承認` (改善項目明記)
   - 期限: クロスレビュー完了から24時間 (提案投稿から72時間以内)
4. **実装トラッキング (Implementation Tracking):**
   - Operations WG: 承認済み ADR の実装アクションを action register へ追加
   - 進捗確認: 毎週の WG ミーティングで報告

#### 3.2 エスカレーションパス
**レベル1: WG 内解決 (24時間以内)**
- トリガー: ドラフト作成遅延、レビュー意見の軽微な対立
- 対応: WG チェアが調整、オーナーへガイダンス提供

**レベル2: クロス WG 調整 (48時間以内)**
- トリガー: 複数 WG 間の意見対立、技術的トレードオフの判断困難
- 対応: Chairs Sync (隔週月曜 17:00) で協議
- 出力: 調整メモを decision-log.md へ追記

**レベル3: Governance Council 判断 (72時間以内)**
- トリガー: Chairs Sync で合意不可、重大なセキュリティ/コンプライアンスリスク
- 対応: Arch + Sec + Ops チェアが Matrix secure room (`!govcouncil:honeylink.local`) で協議
- 最終判断: 投票 (過半数で決定)、反対意見を議事録に明記

**レベル4: 経営層エスカレーション (72時間超)**
- トリガー: Governance Council で合意不可、予算/法務判断が必要
- 対応: CTO/CISO へエスカレーション、法務レビュー依頼
- 期限: 追加の5営業日以内

#### 3.3 緊急承認プロセス (Fast-Track Approval)
**適用条件:** セキュリティインシデント対応、重大な本番障害
**手順:**
1. Incident Commander が `#hl-incident` へ緊急 ADR を投稿
2. Security WG / Operations WG チェアが即座にレビュー (2時間以内)
3. 口頭承認を取得し、事後に正式 ADR を補完 (24時間以内)
4. RCA と併せて decision-log.md へ記録 (72時間以内)

### 4. 品質保証と監査 (Quality Assurance and Auditing)

#### 4.1 ADR 品質チェックリスト
- [ ] ADR ID が一意で連番である
- [ ] タイトルが変更内容を明確に表現している
- [ ] 背景セクションに課題/制約が記載されている
- [ ] 選択肢比較表に最低2案が含まれている
- [ ] C/C++ 依存排除の根拠が明記されている
- [ ] 影響分析 (技術/組織/コスト) が完了している
- [ ] 実施計画に完了条件が定義されている
- [ ] 関連ドキュメントへのリンクが有効である
- [ ] オーナーと日付が正確である

#### 4.2 定期監査
- **月次監査 (Monthly Audit):**
  - Operations WG が全 ADR のステータスを確認
  - 未完了の実施計画をトラッキング
  - 古い `提案中` ステータス (30日超) を調査
- **四半期監査 (Quarterly Audit):**
  - Security WG がコンプライアンス観点で全 ADR をレビュー
  - 実装済み ADR の効果検証 (SLO/KPI との照合)
  - 教訓の横展開状況を確認

---

### 運用メモ
- 重大なセキュリティ/コンプライアンス判断は法務レビュー必須。
- 古い ADR を置換した場合は、旧 ADR のステータスを `置換` に更新。
- 会議メモ ([docs/notes/meeting-notes.md](meeting-notes.md)) とリンクしてトレーサビリティを確保。
- このドキュメント自体の変更も ADR として記録し、バージョン管理する。